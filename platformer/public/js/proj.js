var map =
"111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\
11                                                                                                11                                                11\
11                                                                                                11                                                11\
11            11                                                                            11111111                                                11\
11          5511                                                                                                                                    11\
11          5511                                                                                                                                    11\
1111111111111111   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1                                      2211\
11                                                                                                                                                2211\
11                                                                                                           111111111111    111111111   111  11111111\
11                                                                                                                                                  11\
11                11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111                                      11\
11                11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111                                      11\
11    11111111                                                                                                                                      11\
11                                                                                                                                                  11\
11                                                                                                                                                  11\
11                                                                                                                                                  11\
11           1111111                                                                                                         111111                 11\
11                                                                                                                           111111                 11\
11                                                                                                                           111111                 11\
11                     11111111                                                                                              111111               6611\
11                                                                                                                           111111               6611\
11                                                                                                                           1111111   111111111111111\
11                                                                                                                           1111111   111111111111111\
11           11111111                                                                                                        1111111   111111111111111\
11                                                                                                                                                  11\
11                                                                                                                                                  11\
11                                                                                                                                                  11\
11                     11111111                                                                                                                     11\
11                                                                              1111111111111111111111111111111111111111111111111111111111111111111111\
11                                                                                                                                                  11\
11           11111111                                                                                                                               11\
11                                                                                                                                                  11\
11                                                                                                                                                  11\
11           111111111111111111                                                                                                                     11\
11                                                                                                                                                  11\
11                                 1111111111111111        111111111111     1111111111                                                              11\
11                                 1111111111111111        111111111111     1111111111                                                              11\
11                                                                                                                                                  11\
11                                                                                     1111111                                                      11\
11                                                                                     1111111                                                      11\
11                                                                                                                                                7711\
11                                                                                                                                                7711\
11                                                                                         11111111111111111         111111111111     11       1111111\
11                                                                                                                                                  11\
11                                                           111111111111111111111111111111111                                                      11\
11                                                           111111111111111111111111111111111                                                      11\
11                                     11111111111111111111                                                                                         11\
11                                     11111111111111111111            11                                                                           11\
11                                                                     11                                                                           11\
11    1111111111111111111111111111111                                  11                   111111111                                               11\
11    1111111111111111111111111111111                              11  11                                                                           11\
11                                                                     11                                                                           11\
11                                                             1111    11          111111111                                                        11\
11111111                                                               11                                                                           11\
11                                                        11111        11                                                                           11\
11       1111                                                          11                                                                           11\
11                                                                     11     111111                                                                11\
11   1111                                              111             11                                                                           11\
11                                                                     11                                                                           11\
11                                                                     11           111111                                                          11\
11   1111111111111111      11111111111111111111111111111               11                                                                           11\
11                                                                     11                                                                           11\
11                                                       111           11     111111111111                                                          11\
11                                                                     11                                                                         4411\
11                                                111         111      11                                                                         4411\
11                              1111111111111                          1111111111111111111111111111111111111111111111111111111111111111111111111111111\
11                                                                  1111111111111111111111111111111111111111111111111111111111111111111111111111111111\
11                                                                                                                                                  11\
11                                                                                                                                                  11\
11               11111111111                                11111111                                                                                11\
11                                                                                                                                                  11\
11                                                                                                                                                  11\
11                                                   1111111                                                                                        11\
11  111111111111                                                                                                                                    11\
11                                                               111111                                                                             11\
11                              111111111111111111                                                                                                  11\
11                                                                                                                                                  11\
11                                                                          111111                                                                  11\
11              1111111111111                                                                                                                       11\
11                                                                                                                                                  11\
11                                                                                  1111111111111111111111            11111111111111111111111111111111\
11                                                                                  1111111111111111111111            11111111111111111111111111111111\
11                                                                                                                                                  11\
111111111111111111111111111111111111111111111111111                                                                                                 11\
111111111111111111111111111111111111111111111111111                                                                                                 11\
11                                                          111111111111111111111111                                                                11\
11                                                          111111111111111111111111                                                                11\
11                                                                                                                                                  11\
11                                                                                                                                                  11\
11                                                                                                                                                  11\
11                                                                                1111111111111111111111111                                         11\
11                                                                                1111111111111111111111111                                         11\
11     111111111111111111111111111111111111111111111                        1111111111111111111111111111111                                         11\
11     111111111111111111111111111111111111111111111                                                                                                11\
11                                              1111    111111111111111111                                                                          11\
11                                              1111    1111111111111111111                                                                         11\
11                                              1111                 1111111                                                                        11\
111111111111111111111111111111111111111111      1111                 11111111                                                                       11\
111111111111111111111111111111111111111111      1111111              111111111                                                                      11\
11                                              1111111              1111111111                                                                     11\
1133                                            1111                 11111111111                                                                    11\
1133                                            1111                 111111111111                                                                   11\
111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111             11\
111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111             11\
1                                                                                                                                                   11\
1                                                                                                                                         111111111111\
1                                                        111111111111111111111111                                                                   11\
1                                                                                                                                 11111             11\
1                                                                                                                                                   11\
1111111      111111111111                     11111111                                                                                              11\
1                                                                                                                     11111111                      11\
1                             1111111111111                                                                                                         11\
1                                                                             11111111111111111111111111111111111                                   11\
1                                                                                                                                                   11\
1                                                                                                                                                   11\
1                              1111111111111111111111                1111                                                                           11\
1                                                                                                                                                   11\
1                                                        11111111                                                                                   11\
1       1111111111111111111                                                                                                                       8811\
1                                                                                                                                                 8811\
111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\
111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111\
";

var mapHeight = 122;
var mapWidth = 150;

function Player(name, maxSpeed) 
{
    // from constructor
    this.playerName = name;
    this.maxSpeed = maxSpeed;
    
// initialize player state
    this.x = 60;
    this.y = (mapHeight-5)*25;
    this.xForce = 0;
    this.yForce = 0;
    this.holdJump = 0;
    this.frame = 0;
    this.jumping = false;
    this.movingLeft = false;
    this.movingRight = false;
    this.orientation = 1;
    
    // position on map
    this.left = 0;
    this.right = 0;
    this.top = 0;
    this.bottom = 0;
}

/********************************
    INITIALIZE and start
    the game
********************************/
/*
function initialize()
{
    var game = new GameManager(1000, Object.create(clientConnectionManager));
}*/

// Class that will make the game happen
var GameManager =  
{
    serverHandler: null,
    players: null,
    mainPlayer: null,
    playerSheet: null,
    tileSheet: null,

    init: function(pName) {
    
        // setup socket interface
        this.serverHandler = clientConnectionManager;
        
        /* setup web worker for server handling
        this.serverHandler = new Worker("js/worker.js");
        
        // setup callback function for web workers
        this.serverHandler.onmessage = function (event) {
            GameManager.players = event.data;
        }
        
        this.serverHandler.onerror = function (error) {
            alert("Worker Error: " + error.message + "\n");
        }*/
            
        // create players array
        this.players = new Array();
        
        this.moveFrame = 0;
        
        // Initialize win number
        
        this.serverHandler.getWinningNumber();
        
        var name = "";
        
        // get the player's name
        if (!pName) {
            name = window.prompt("What is your name?", "Default");
        }
        else {
            name = pName;
        }
        
        // tell the user what to do
        playRace();
        alert("Find the red door at the end of the platform maze before your opponents do!\nGood luck!");
        
        // preload images for the game
        this.playerSheet = new Image();
        this.playerSheet.src = "megaman.png";
        this.tileSheet = new Image();
        this.tileSheet.src = "tiles.png";
        this.bg = new Image();
        this.bg.src = "city.jpg";

        // load wins into html
        var wins = this.getWins();
        document.getElementById('wins').innerHTML = wins;
        
        // add the player for this client
        this.mainPlayer = new Player(name, 9);
		this.scrollX = -this.mainPlayer.x + 250;
		this.scrollY = -this.mainPlayer.y + 250;
		if (this.scrollX > 0) {
		    this.scrollX = 0;
		}
		if (this.scrollY > 0) {
		    this.scrollY = 0;
		}
        this.players.push(this.mainPlayer);
          
        this.serverHandler.updatePlayer(this.mainPlayer);
        //this.serverHandler.postMessage({text: "update", player: this.mainPlayer});
          
        // Start event listeners for key presses
        if (!document.addEventListener && document.attachEvent) {
         	// Internet Explorer version
           	document.attachEvent('onkeydown', this.handleKeyDown);
           	document.attachEvent('onkeypress', this.handleKeyPress);
           	document.attachEvent('onkeyup', this.handleKeyUp);
           	document.attachEvent('onbeforeunload', this.onClose);
        } 
        else {
	        window.addEventListener('keydown', this.handleKeyDown, true);
          	window.addEventListener('keypress', this.handleKeyPress, true);
          	window.addEventListener('keyup', this.handleKeyUp, true);
        }
        window.onbeforeunload = this.onClose;
        window.onunload = this.onClose;
        window.onclose = this.onClose;
        
        // create the map
        this.map = loadMap(map);
        this.scrollX = 0;
        
        this.requestPlayers = true;
        
        // setup looping audio
        this.audio = new Audio("theme.ogg");
        this.audio.play();
 
        
        this.audio.addEventListener('ended', loopMusic, false);
                   
        // start game clock
        setInterval(this.clockTick, 40);
    },
    
 
    /********************************
        CLOCK TICK -- Progresses
        the game state
    ********************************/
    
    clockTick: function() {
    
        // Get updated player positions from the server
        var gm = GameManager;
        
        // get the player object
        var player = gm.mainPlayer;
        
        /*******************************
            PLAYER
                   LOCATION
                            CALCULATION
        /******************************/
        
        player.left = Math.floor((player.x)/25);
        player.top = Math.floor((player.y) / 25);
        player.bottom = Math.floor((player.y) / 25)+1;
        player.right = Math.floor((player.x)/25)+1;
        
        /*******************************
            HORIZONTAL 
                        MOVEMENT
        *******************************/
        
        // move the player left or right
        if (player.movingLeft) {
            //Iterate through movement frames
            gm.moveFrame += 1;
            player.xForce -= 0.5;
            player.orientation = 0;
            //Set movement frames to 0 when they reach 6 (end of loop)
            if(gm.moveFrame == 6) {
                gm.moveFrame = 0;
            }
        }
        else if (player.movingRight) {
            //Iterate through movement frames
            gm.moveFrame += 1;
            player.xForce += 0.5;
            player.orientation = 1;
            //Set movement frames to 0 when they reach 6 (end of loop)
            if(gm.moveFrame == 6) {
                gm.moveFrame = 0;
            }
        }
        else {
            // slow down movement if no key is held
            if (player.xForce > 0) {
                player.xForce -= 0.5;
            }
            if (player.xForce < 0) {
                player.xForce += 0.5;
            }
        }
        
        // Limit speed of player
        if (player.xForce > player.maxSpeed) {
            player.xForce = player.maxSpeed;
        }
        if (player.xForce < -1*player.maxSpeed) {
            player.xForce = -1*player.maxSpeed;
        }
        
        // check for a collision on the left
        var collideX = false;
        if (gm.map[player.left][Math.floor((player.y+1) / 25)] === 1) {
            player.x = ((player.right) * 25);
            player.xForce = 0;
            collideX = true;
        }        
        if (gm.map[player.right][Math.floor((player.y+1) / 25)] === 1) {
            player.x = ((player.left) * 25)-1;
            player.xForce = 0;
            collideX = true;
        }
        
        // Move the player horizontally if they did not collide
        if (collideX === false) {
            player.x += player.xForce;
        }
        
        // Scroll if necessary
        if (player.x + gm.scrollX > 250 && player.xForce > 0) {
            gm.scrollX -= Math.floor(player.xForce);
        }
        if (player.x + gm.scrollX < 250 && player.xForce < 0) {
            gm.scrollX -= Math.floor(player.xForce);
        }
        if (gm.scrollX > 0) {
            gm.scrollX = 0;
        }
	    if ((gm.scrollX - 500) < (-25*mapWidth)) {
		    gm.scrollX = (-25*mapWidth) + 500;
		}
        
        /*******************************
            VERTICAL 
                         MOVEMENT
        *******************************/
        
        // keep track of if player is holding the jump key -- also must be on ground
        // to start a jump
        if (player.jumping && player.holdJump === 0 && (gm.map[player.right][player.bottom] === 1 || gm.map[player.left][player.bottom] === 1) && collideX === false) {
            player.holdJump = 1;
        }
        
        // perform jump
        if (player.jumping && player.holdJump > 0 && player.holdJump <= 5) {
            player.yForce -= 7;
            if (player.yForce < 0) {
                player.holdJump++;
            }
        }
        
        // don't let player jump too high
        if (!player.jumping || player.holdJump >= 5) {
            player.holdJump = 0;
        }
        
        // Max jump speed
        if (player.yForce < -22) {
            player.yForce = -22;
        }
        
        // Max gravity
        if (player.yForce > 18) {
            player.yForce = 18;
        }
        
        // Apply gravity
        player.yForce += 2.2;
        
        // Move player up/down if there was no collision
        player.y += player.yForce;
        
        // recaluclate positioning
        player.left = Math.floor((player.x)/25);
        player.top = Math.floor((player.y) / 25);
        player.bottom = Math.floor((player.y) / 25)+1;
        player.right = Math.floor((player.x)/25)+1;
        
        // Scroll if necessary
        if (player.y + gm.scrollY > 250 && player.yForce > 0) {
            gm.scrollY -= Math.floor(player.yForce);
        }
        if (player.y + gm.scrollY < 250 && player.yForce < 0) {
            gm.scrollY -= Math.floor(player.yForce);
        }
        if (gm.scrollY > 0) {
            gm.scrollY = 0;
        }
	    if ((gm.scrollY - 500) < (-25*mapHeight)) {
		    gm.scrollY = (-25*mapHeight) + 500;
		}
		
        // check for a collision
        if ((gm.map[player.right][player.bottom] === 1 && gm.map[player.left][player.bottom] === 1) || (gm.map[player.right][player.bottom] === 1
            && !player.jumping && gm.map[player.right][Math.floor((player.y+1) / 25)] !== 1) || (gm.map[player.left][player.bottom] === 1 
            && !player.jumping && gm.map[player.left][Math.floor((player.y+1) / 25)] !== 1)) {
            player.y = ((player.top) * 25);
            player.yForce = 0;
        }        
        if ((gm.map[player.right][player.top] === 1 && gm.map[player.left][player.top] === 1) || (gm.map[player.right][player.top] === 1
            && !player.jumping && gm.map[player.right][Math.floor((player.y+1) / 25)] !== 1) || (gm.map[player.left][player.top] === 1 
            && !player.jumping && gm.map[player.left][Math.floor((player.y+1) / 25)] !== 1)) {
            player.y = ((player.bottom) * 25);
            player.yForce = 0;
        }
        //gm.serverHandler.postMessage({text: "update", player: this.mainPlayer});
        gm.serverHandler.updatePlayer(gm.mainPlayer);
        
        // check for a win
        if (gm.map[Math.floor((player.x+15)/25)][player.top] === gm.currentWin) {
            gm.serverHandler.reportWin(gm.mainPlayer);
            gm.saveWins();
        }
		
        // draw the game to screen
        gm.draw();
        
    },
    
    
    /****************************
        DRAW -- draws the game
        onto the HTML canvas
    ****************************/
    
    draw: function() {
        
        // check if there are players in the game, and then draw them
        // if there are
        if (this.players) {
            
            // get canvas information
            var canvas = document.getElementById("gameCanvas");
            var ctx = canvas.getContext('2d');
            
            // clear the canvas, and redraw
            canvas.width = canvas.width;
            
            /* draw main player
            
            ctx.drawImage(this.playerSheet,2,19,23,23,Math.floor(this.mainPlayer.x+this.scrollX),Math.floor(this.mainPlayer.y+this.scrollY),25,25);            
               
            // draw the player's name
            ctx.font = "12px Arial";
            ctx.fillStyle = "rgba(0, 0, 0, 1)";
            ctx.fillText(this.mainPlayer.playerName, Math.floor(this.mainPlayer.x+this.scrollX), Math.floor(this.mainPlayer.y+this.scrollY)-22.5);
            */
            
            ctx.drawImage(this.bg, 0, 0, 500, 500);

            // draw loop -- draw each player
            for (var i = 0; i < this.players.length; i++) {
                //Draw Jump Animation
                if(this.players[i].jumping == true) {
                    //Draw Left Jump Animation
                    if(this.players[i].movingLeft == true) {
                        ctx.drawImage(this.playerSheet,195,10,26,30,Math.floor(this.players[i].x+this.scrollX),Math.floor(this.players[i].y+this.scrollY),29,34);     
                    }
                    //Draw Right Jump Animation
                    else {
                        ctx.drawImage(this.playerSheet,470,54,26,30,Math.floor(this.players[i].x+this.scrollX),Math.floor(this.players[i].y+this.scrollY),29,34);   
                    } 
                } 
                //Draw Move Left Animation, loops through 3 frames
                else if(this.players[i].movingLeft == true) {
                    //Frame 1/2 run
                    if(this.moveFrame == 0 || this.moveFrame == 1) {
                        ctx.drawImage(this.playerSheet,135,20,21,22,Math.floor(this.players[i].x+this.scrollX),Math.floor(this.players[i].y+this.scrollY),25,25);
                    }
                    //Frame 3/4 run 
                    else if(this.moveFrame == 2 || this.moveFrame == 3) {
                        ctx.drawImage(this.playerSheet,111,18,16,24,Math.floor(this.players[i].x+this.scrollX),Math.floor(this.players[i].y+this.scrollY),20,30);
                    }
                    //frame 5/6 run
                    else if(this.moveFrame == 4 || this.moveFrame == 5) {
                        ctx.drawImage(this.playerSheet,81,20,24,22,Math.floor(this.players[i].x+this.scrollX),Math.floor(this.players[i].y+this.scrollY),25,25);
                    }      
                }
                //Draw Move Right Animation, Loops through 3 frames
                else if(this.players[i].movingRight == true) {
                    //Frame 1/2 run
                    if(this.moveFrame == 0 || this.moveFrame == 1) {
                        ctx.drawImage(this.playerSheet,535,64,21,22,Math.floor(this.players[i].x+this.scrollX),Math.floor(this.players[i].y+this.scrollY),25,25);
                    }
                    //Frame 3/4 run
                    else if(this.moveFrame == 2 || this.moveFrame == 3) {
                        ctx.drawImage(this.playerSheet,564,62,16,24,Math.floor(this.players[i].x+this.scrollX),Math.floor(this.players[i].y+this.scrollY),18,25);
                    }
                    //Frame 5/6 run
                    else if(this.moveFrame == 4 || this.moveFrame == 5) {
                        ctx.drawImage(this.playerSheet,586,64,24,22,Math.floor(this.players[i].x+this.scrollX),Math.floor(this.players[i].y+this.scrollY),25,25);
                    }          
                }
                //Draw directionless animation
                else {
                    if (this.players[i].orientation == 1) {
                        ctx.drawImage(this.playerSheet,617,62,23,23,Math.floor(this.players[i].x+this.scrollX),Math.floor(this.players[i].y+this.scrollY),25,25);   
                    }
                    else {
                        ctx.drawImage(this.playerSheet,3,18,21,24,Math.floor(this.players[i].x+this.scrollX),Math.floor(this.players[i].y+this.scrollY),25,25); 
                    }
                }       
                    
                // draw the player's name
                ctx.font = "12px Arial";
                ctx.fillStyle = "rgba(0, 0, 0, 1)";
                ctx.fillText(this.players[i].playerName, Math.floor(this.players[i].x+this.scrollX), Math.floor(this.players[i].y+this.scrollY)-22.5);
            }
        }
        
        // draw the map
        for (var i = 0; i < this.map.length; i++) {
            for (var j = 0; j < this.map.length; j++) {
                
                // draw a solid block
                if (this.map[i][j] === 1) {
                    ctx.drawImage(this.tileSheet,156,48,16,16,(i*25)+this.scrollX, (j*25)+this.scrollY,25,25);
                }

                if (this.map[i][j] === this.currentWin) {
                    ctx.drawImage(this.tileSheet,277,240,16,16,(i*25)+this.scrollX, (j*25)+this.scrollY,25,25);
                    
                }
            }
        }
    },

    /**************************
        KEY EVENT HANDLERS
    **************************/
    
    // on key press
    handleKeyPress: function(event)
    {
        return stopPropagation(event.charCode, event);
    }, 
  
    // on key down
    handleKeyDown: function(event)
    {
        if (event.keyCode == 38) // up
    	    GameManager.mainPlayer.jumping = true;
        else if (event.keyCode == 37) // left
    	    GameManager.mainPlayer.movingLeft = true;
        else if (event.keyCode == 39) // right
    	    GameManager.mainPlayer.movingRight = true;
        return stopPropagation(event.keyCode, event);
    },
    
    // on key up (release)
    handleKeyUp: function(event)
    {
        if (event.keyCode == 38) // up
	        GameManager.mainPlayer.jumping = false;
        else if (event.keyCode == 37) // left
	        GameManager.mainPlayer.movingLeft = false;
        else if (event.keyCode == 39) // right
	        GameManager.mainPlayer.movingRight = false;

        return stopPropagation(event.keyCode, event);
    },
    
    // disconnect from server
    onClose: function(event)
    {
        GameManager.serverHandler.disconnect(GameManager.mainPlayer);
        //GameManager.serverHandler.postMessage({text: "disconnect", player: this.mainPlayer});
    },
    
    /*******************************
        UPDATE WINNING
                LOCATION
    ********************************/
    
    updateWinningNumber: function(number)
    {
        this.currentWin = number;
    },

    saveWins: function()
    {
        var newWins = localStorage.getItem('wins');
        wins = JSON.parse(newWins);
        if(wins === null) {
            wins = 0;
        }
        wins++;
        localStorage.removeItem('wins');
        localStorage.setItem('wins',JSON.stringify(wins));
    },

    getWins: function()
    {
        var wins = localStorage.getItem('wins');
        playerWins = JSON.parse(wins);
        if(wins === null) {
            wins = 0;
        }
        return wins;
    },
    
    
    /*******************************
        RESTART GAME
    *******************************/
    
    restart: function(name)
    {
        // tell clients who won
        alert(name+" has won the round! Restarting the game.");
        
        // reset game state
        this.mainPlayer.x = 60;
        this.mainPlayer.y = (mapHeight-5)*25;
        this.mainPlayer.xForce = 0;
        this.mainPlayer.yForce = 0;
        
		this.scrollX = -this.mainPlayer.x + 250;
		this.scrollY = -this.mainPlayer.y + 250;
		if (this.scrollX > 0) {
		    this.scrollX = 0;
		}
		if (this.scrollY > 0) {
		    this.scrollY = 0;
		}
        
        // tell the user what to do
        playRace();
        alert("Find the red door at the end of the platform maze before your opponents do!\nGood luck!");
        
        // load wins into html
        var wins = this.getWins();
        document.getElementById('wins').innerHTML = wins;
    }
};

// stops propagation of events
stopPropagation = function(keyCode, event) {
    if (keyCode == 37 || keyCode == 38 || keyCode == 39) {
        if (event.preventDefault) event.preventDefault();
		if (event.stopPropagation) event.stopPropagation();
		return false;
   }
}


// turn map file string into usable two-dimensional array
function loadMap(map) {

    var mapData = new Array(mapWidth);
    
    for (var i = 0; i < mapWidth; i++) {
        mapData[i] = new Array(mapHeight);
    }

    // 150 columns
    for (var i = 0; i < mapWidth; i++) {
        // 20 rows
        for (var j = 0; j < mapHeight; j++) {
        
            // load the current tile
            var tile = map[i + (mapWidth*j)];
            
            // convert to integer
            mapData[i][j] = parseInt(tile);
        }
    }
    return mapData;
}

function loopMusic() {
    GameManager.audio = new Audio("theme.ogg");
    GameManager.audio.play();
    GameManager.audio.addEventListener('ended', loopMusic, false);
}

function playRace() {
    var audio = new Audio("race.ogg");
    audio.play();
}
